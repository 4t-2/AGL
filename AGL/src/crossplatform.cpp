#include "../include/external.hpp"

// #ifdef _WIN32

const agl::Key agl::Key::Space		  = {GLFW_KEY_SPACE};
const agl::Key agl::Key::Apostrophe	  = {GLFW_KEY_APOSTROPHE};
const agl::Key agl::Key::Comma		  = {GLFW_KEY_COMMA};
const agl::Key agl::Key::Minus		  = {GLFW_KEY_MINUS};
const agl::Key agl::Key::Period		  = {GLFW_KEY_PERIOD};
const agl::Key agl::Key::Slash		  = {GLFW_KEY_SLASH};
const agl::Key agl::Key::Num0		  = {GLFW_KEY_0};
const agl::Key agl::Key::Num1		  = {GLFW_KEY_1};
const agl::Key agl::Key::Num2		  = {GLFW_KEY_2};
const agl::Key agl::Key::Num3		  = {GLFW_KEY_3};
const agl::Key agl::Key::Num4		  = {GLFW_KEY_4};
const agl::Key agl::Key::Num5		  = {GLFW_KEY_5};
const agl::Key agl::Key::Num6		  = {GLFW_KEY_6};
const agl::Key agl::Key::Num7		  = {GLFW_KEY_7};
const agl::Key agl::Key::Num8		  = {GLFW_KEY_8};
const agl::Key agl::Key::Num9		  = {GLFW_KEY_9};
const agl::Key agl::Key::Semicolon	  = {GLFW_KEY_SEMICOLON};
const agl::Key agl::Key::Equal		  = {GLFW_KEY_EQUAL};
const agl::Key agl::Key::A			  = {GLFW_KEY_A};
const agl::Key agl::Key::B			  = {GLFW_KEY_B};
const agl::Key agl::Key::C			  = {GLFW_KEY_C};
const agl::Key agl::Key::D			  = {GLFW_KEY_D};
const agl::Key agl::Key::E			  = {GLFW_KEY_E};
const agl::Key agl::Key::F			  = {GLFW_KEY_F};
const agl::Key agl::Key::G			  = {GLFW_KEY_G};
const agl::Key agl::Key::H			  = {GLFW_KEY_H};
const agl::Key agl::Key::I			  = {GLFW_KEY_I};
const agl::Key agl::Key::J			  = {GLFW_KEY_J};
const agl::Key agl::Key::K			  = {GLFW_KEY_K};
const agl::Key agl::Key::L			  = {GLFW_KEY_L};
const agl::Key agl::Key::M			  = {GLFW_KEY_M};
const agl::Key agl::Key::N			  = {GLFW_KEY_N};
const agl::Key agl::Key::O			  = {GLFW_KEY_O};
const agl::Key agl::Key::P			  = {GLFW_KEY_P};
const agl::Key agl::Key::Q			  = {GLFW_KEY_Q};
const agl::Key agl::Key::R			  = {GLFW_KEY_R};
const agl::Key agl::Key::S			  = {GLFW_KEY_S};
const agl::Key agl::Key::T			  = {GLFW_KEY_T};
const agl::Key agl::Key::U			  = {GLFW_KEY_U};
const agl::Key agl::Key::V			  = {GLFW_KEY_V};
const agl::Key agl::Key::W			  = {GLFW_KEY_W};
const agl::Key agl::Key::X			  = {GLFW_KEY_X};
const agl::Key agl::Key::Y			  = {GLFW_KEY_Y};
const agl::Key agl::Key::Z			  = {GLFW_KEY_Z};
const agl::Key agl::Key::LeftBracket  = {GLFW_KEY_LEFT_BRACKET};
const agl::Key agl::Key::Backslash	  = {GLFW_KEY_BACKSLASH};
const agl::Key agl::Key::RightBracket = {GLFW_KEY_RIGHT_BRACKET};
const agl::Key agl::Key::Grave		  = {GLFW_KEY_GRAVE_ACCENT};
const agl::Key agl::Key::Escape		  = {GLFW_KEY_ESCAPE};
const agl::Key agl::Key::Return		  = {GLFW_KEY_ENTER};
const agl::Key agl::Key::Tab		  = {GLFW_KEY_TAB};
const agl::Key agl::Key::Backspace	  = {GLFW_KEY_BACKSPACE};
const agl::Key agl::Key::Insert		  = {GLFW_KEY_INSERT};
const agl::Key agl::Key::Delete		  = {GLFW_KEY_DELETE};
const agl::Key agl::Key::Right		  = {GLFW_KEY_RIGHT};
const agl::Key agl::Key::Left		  = {GLFW_KEY_LEFT};
const agl::Key agl::Key::Down		  = {GLFW_KEY_DOWN};
const agl::Key agl::Key::Up			  = {GLFW_KEY_UP};
const agl::Key agl::Key::PageUp		  = {GLFW_KEY_PAGE_UP};
const agl::Key agl::Key::PageDown	  = {GLFW_KEY_PAGE_DOWN};
const agl::Key agl::Key::Home		  = {GLFW_KEY_HOME};
const agl::Key agl::Key::End		  = {GLFW_KEY_END};
const agl::Key agl::Key::CapsLock	  = {GLFW_KEY_CAPS_LOCK};
const agl::Key agl::Key::ScrollLock	  = {GLFW_KEY_SCROLL_LOCK};
const agl::Key agl::Key::NumLock	  = {GLFW_KEY_NUM_LOCK};
const agl::Key agl::Key::PrintScreen  = {GLFW_KEY_PRINT_SCREEN};
const agl::Key agl::Key::Pause		  = {GLFW_KEY_PAUSE};
const agl::Key agl::Key::F1			  = {GLFW_KEY_F1};
const agl::Key agl::Key::F2			  = {GLFW_KEY_F2};
const agl::Key agl::Key::F3			  = {GLFW_KEY_F3};
const agl::Key agl::Key::F4			  = {GLFW_KEY_F4};
const agl::Key agl::Key::F5			  = {GLFW_KEY_F5};
const agl::Key agl::Key::F6			  = {GLFW_KEY_F6};
const agl::Key agl::Key::F7			  = {GLFW_KEY_F7};
const agl::Key agl::Key::F8			  = {GLFW_KEY_F8};
const agl::Key agl::Key::F9			  = {GLFW_KEY_F9};
const agl::Key agl::Key::F10		  = {GLFW_KEY_F10};
const agl::Key agl::Key::F11		  = {GLFW_KEY_F11};
const agl::Key agl::Key::F12		  = {GLFW_KEY_F12};
const agl::Key agl::Key::F13		  = {GLFW_KEY_F13};
const agl::Key agl::Key::F14		  = {GLFW_KEY_F14};
const agl::Key agl::Key::F15		  = {GLFW_KEY_F15};
const agl::Key agl::Key::F16		  = {GLFW_KEY_F16};
const agl::Key agl::Key::F17		  = {GLFW_KEY_F17};
const agl::Key agl::Key::F18		  = {GLFW_KEY_F18};
const agl::Key agl::Key::F19		  = {GLFW_KEY_F19};
const agl::Key agl::Key::F20		  = {GLFW_KEY_F20};
const agl::Key agl::Key::F21		  = {GLFW_KEY_F21};
const agl::Key agl::Key::F22		  = {GLFW_KEY_F22};
const agl::Key agl::Key::F23		  = {GLFW_KEY_F23};
const agl::Key agl::Key::F24		  = {GLFW_KEY_F24};
const agl::Key agl::Key::F25		  = {GLFW_KEY_F25};
const agl::Key agl::Key::LeftShift	  = {GLFW_KEY_LEFT_SHIFT};
const agl::Key agl::Key::LeftControl  = {GLFW_KEY_LEFT_CONTROL};
const agl::Key agl::Key::LeftAlt	  = {GLFW_KEY_LEFT_ALT};
const agl::Key agl::Key::LeftSuper	  = {GLFW_KEY_LEFT_SUPER};
const agl::Key agl::Key::RightShift	  = {GLFW_KEY_RIGHT_SHIFT};
const agl::Key agl::Key::RightControl = {GLFW_KEY_RIGHT_CONTROL};
const agl::Key agl::Key::RightAlt	  = {GLFW_KEY_RIGHT_ALT};
const agl::Key agl::Key::RightSuper	  = {GLFW_KEY_RIGHT_SUPER};

const agl::Button agl::Button::Left	  = {GLFW_MOUSE_BUTTON_1};
const agl::Button agl::Button::Middle = {GLFW_MOUSE_BUTTON_3};
const agl::Button agl::Button::Right  = {GLFW_MOUSE_BUTTON_2};

void agl::createWindow(agl::BaseWindow &window, agl::Vec<int, 2> size, std::string title)
{
	glfwInit();

	glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3);
	glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3);
	glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);

	window.window = glfwCreateWindow(size.x, size.y, title.c_str(), NULL, NULL);
}

void agl::initGL(agl::BaseWindow &window)
{
	glfwMakeContextCurrent(window.window);
	glewInit();
}

void agl::mapWindow(agl::BaseWindow &window)
{
	glfwShowWindow(window.window);
}

void agl::setSwapInterval(agl::BaseWindow &window, int i)
{
	glfwSwapInterval(i);
}

void agl::setCursorShape(agl::BaseWindow &window, unsigned int shape)
{
}

void agl::swapBuffers(agl::BaseWindow &window)
{
	glfwSwapBuffers(window.window);
}

void agl::closeWindow(agl::BaseWindow &window)
{
	glfwDestroyWindow(window.window);
	glfwTerminate();
}

std::string buf			= "";
bool		windowClose = false;
float scrolloffset = 0;

void closeCallback(GLFWwindow *window)
{
	windowClose = true;
}

void charCallback(GLFWwindow *window, unsigned int codepoint)
{
	buf += (char)codepoint;
}

void scrollCallback(GLFWwindow* window, double xoffset, double yoffset)
{
	scrolloffset = yoffset;
}

void agl::setupEvent(agl::BaseEvent &event, agl::BaseWindow &window)
{
	event.window = window.window;

	buf			= "";
	windowClose = false;

	glfwSetCharCallback(window.window, charCallback);
	glfwSetWindowCloseCallback(window.window, closeCallback);
	glfwSetScrollCallback(window.window, scrollCallback);
}

int agl::currentKeyPressed(agl::BaseEvent &event, char buffer[2])
{
	return 0;
}

void agl::pollEvents(BaseEvent &event, char keymap[32], agl::Vec<int, 2> &root, agl::Vec<int, 2> &win,
					 unsigned int &maskReturn, bool &shouldWindowClose, std::string &keybuffer, Direction &scroll)
{
	glfwPollEvents();

	agl::Vec<double, 2> cursorPos;

	glfwGetCursorPos(event.window, &cursorPos.x, &cursorPos.y);

	agl::Vec<int, 2> winPos;

	glfwGetWindowPos(event.window, &winPos.x, &winPos.y);

	if(scrolloffset > 0)
	{
		scroll = Up;
	} else if(scrolloffset < 0)
	{
		scroll = Down;
	}	

	root = cursorPos;
	win	 = cursorPos - win;

	shouldWindowClose = windowClose;
	keybuffer		  = buf;

	windowClose = false;
	buf = "";
	scrolloffset = 0;
}

bool agl::isKeyPressed(agl::BaseEvent &event, char keymap[32], agl::Key key)
{
	return glfwGetKey(event.window, key.code);
}

bool agl::isButtonPressed(agl::BaseEvent &event, int maskReturn, Button button)
{
	return glfwGetMouseButton(event.window, button.code);
}

agl::WindowState agl::getWindowState(agl::BaseWindow &window)
{
	agl::Vec<int, 2> pos;
	agl::Vec<int, 2> size;

	glfwGetWindowPos(window.window, &pos.x, &pos.y);
	glfwGetWindowSize(window.window, &size.x, &size.y);

	return {size, pos};
}

// #endif

#ifdef __linux__a

const agl::Key agl::Key::Space		  = {XK_space};
const agl::Key agl::Key::Apostrophe	  = {XK_apostrophe};
const agl::Key agl::Key::Comma		  = {XK_comma};
const agl::Key agl::Key::Minus		  = {XK_minus};
const agl::Key agl::Key::Period		  = {XK_period};
const agl::Key agl::Key::Slash		  = {XK_slash};
const agl::Key agl::Key::Num0		  = {XK_0};
const agl::Key agl::Key::Num1		  = {XK_1};
const agl::Key agl::Key::Num2		  = {XK_2};
const agl::Key agl::Key::Num3		  = {XK_3};
const agl::Key agl::Key::Num4		  = {XK_4};
const agl::Key agl::Key::Num5		  = {XK_5};
const agl::Key agl::Key::Num6		  = {XK_6};
const agl::Key agl::Key::Num7		  = {XK_7};
const agl::Key agl::Key::Num8		  = {XK_8};
const agl::Key agl::Key::Num9		  = {XK_9};
const agl::Key agl::Key::Semicolon	  = {XK_semicolon};
const agl::Key agl::Key::Equal		  = {XK_equal};
const agl::Key agl::Key::A			  = {XK_A};
const agl::Key agl::Key::B			  = {XK_B};
const agl::Key agl::Key::C			  = {XK_C};
const agl::Key agl::Key::D			  = {XK_D};
const agl::Key agl::Key::E			  = {XK_E};
const agl::Key agl::Key::F			  = {XK_F};
const agl::Key agl::Key::G			  = {XK_G};
const agl::Key agl::Key::H			  = {XK_H};
const agl::Key agl::Key::I			  = {XK_I};
const agl::Key agl::Key::J			  = {XK_J};
const agl::Key agl::Key::K			  = {XK_K};
const agl::Key agl::Key::L			  = {XK_L};
const agl::Key agl::Key::M			  = {XK_M};
const agl::Key agl::Key::N			  = {XK_N};
const agl::Key agl::Key::O			  = {XK_O};
const agl::Key agl::Key::P			  = {XK_P};
const agl::Key agl::Key::Q			  = {XK_Q};
const agl::Key agl::Key::R			  = {XK_R};
const agl::Key agl::Key::S			  = {XK_S};
const agl::Key agl::Key::T			  = {XK_T};
const agl::Key agl::Key::U			  = {XK_U};
const agl::Key agl::Key::V			  = {XK_V};
const agl::Key agl::Key::W			  = {XK_W};
const agl::Key agl::Key::X			  = {XK_X};
const agl::Key agl::Key::Y			  = {XK_Y};
const agl::Key agl::Key::Z			  = {XK_Z};
const agl::Key agl::Key::LeftBracket  = {XK_bracketleft};
const agl::Key agl::Key::Backslash	  = {XK_backslash};
const agl::Key agl::Key::RightBracket = {XK_bracketright};
const agl::Key agl::Key::Grave		  = {XK_grave};
const agl::Key agl::Key::Escape		  = {XK_Escape};
const agl::Key agl::Key::Return		  = {XK_Return};
const agl::Key agl::Key::Tab		  = {XK_Tab};
const agl::Key agl::Key::Backspace	  = {XK_BackSpace};
const agl::Key agl::Key::Insert		  = {XK_Insert};
const agl::Key agl::Key::Delete		  = {XK_Delete};
const agl::Key agl::Key::Right		  = {XK_Right};
const agl::Key agl::Key::Left		  = {XK_Left};
const agl::Key agl::Key::Down		  = {XK_Down};
const agl::Key agl::Key::Up			  = {XK_Up};
const agl::Key agl::Key::PageUp		  = {XK_Page_Up};
const agl::Key agl::Key::PageDown	  = {XK_Page_Down};
const agl::Key agl::Key::Home		  = {XK_Home};
const agl::Key agl::Key::End		  = {XK_End};
const agl::Key agl::Key::CapsLock	  = {XK_Caps_Lock};
const agl::Key agl::Key::ScrollLock	  = {XK_Scroll_Lock};
const agl::Key agl::Key::NumLock	  = {XK_Num_Lock};
const agl::Key agl::Key::PrintScreen  = {XK_Print};
const agl::Key agl::Key::Pause		  = {XK_Pause};
const agl::Key agl::Key::F1			  = {XK_F1};
const agl::Key agl::Key::F2			  = {XK_F2};
const agl::Key agl::Key::F3			  = {XK_F3};
const agl::Key agl::Key::F4			  = {XK_F4};
const agl::Key agl::Key::F5			  = {XK_F5};
const agl::Key agl::Key::F6			  = {XK_F6};
const agl::Key agl::Key::F7			  = {XK_F7};
const agl::Key agl::Key::F8			  = {XK_F8};
const agl::Key agl::Key::F9			  = {XK_F9};
const agl::Key agl::Key::F10		  = {XK_F10};
const agl::Key agl::Key::F11		  = {XK_F11};
const agl::Key agl::Key::F12		  = {XK_F12};
const agl::Key agl::Key::F13		  = {XK_F13};
const agl::Key agl::Key::F14		  = {XK_F14};
const agl::Key agl::Key::F15		  = {XK_F15};
const agl::Key agl::Key::F16		  = {XK_F16};
const agl::Key agl::Key::F17		  = {XK_F17};
const agl::Key agl::Key::F18		  = {XK_F18};
const agl::Key agl::Key::F19		  = {XK_F19};
const agl::Key agl::Key::F20		  = {XK_F20};
const agl::Key agl::Key::F21		  = {XK_F21};
const agl::Key agl::Key::F22		  = {XK_F22};
const agl::Key agl::Key::F23		  = {XK_F23};
const agl::Key agl::Key::F24		  = {XK_F24};
const agl::Key agl::Key::F25		  = {XK_F25};
const agl::Key agl::Key::LeftShift	  = {XK_Shift_L};
const agl::Key agl::Key::LeftControl  = {XK_Control_L};
const agl::Key agl::Key::LeftAlt	  = {XK_Alt_L};
const agl::Key agl::Key::LeftSuper	  = {XK_Super_L};
const agl::Key agl::Key::RightShift	  = {XK_Shift_R};
const agl::Key agl::Key::RightControl = {XK_Control_R};
const agl::Key agl::Key::RightAlt	  = {XK_Alt_R};
const agl::Key agl::Key::RightSuper	  = {XK_Super_R};

const agl::Button agl::Button::Left	  = {Button1Mask};
const agl::Button agl::Button::Middle = {Button2Mask};
const agl::Button agl::Button::Right  = {Button3Mask};

void agl::createWindow(BaseWindow &window, agl::Vec<int, 2> size, std::string title)
{
	GLint attribute[5] = {GLX_RGBA, GLX_DEPTH_SIZE, 24, GLX_DOUBLEBUFFER, None};

	window.dpy		 = XOpenDisplay(NULL);
	window.root		 = DefaultRootWindow(window.dpy);
	window.vi		 = glXChooseVisual(window.dpy, 0, attribute);
	window.cmap		 = XCreateColormap(window.dpy, window.root, window.vi->visual, AllocNone);
	window.eventMask = ExposureMask | KeyPressMask | KeyReleaseMask;
	XSetWindowAttributes swa;
	swa.colormap   = window.cmap;
	swa.event_mask = window.eventMask;

	window.win = XCreateWindow(window.dpy, window.root, 0, 0, size.x, size.y, 0, window.vi->depth, InputOutput,
							   window.vi->visual, CWColormap | CWEventMask,
							   &swa); // window is created and the function returns an id

	XStoreName(window.dpy, window.win, title.c_str());
}

void agl::initGL(agl::BaseWindow &window)
{
	window.glc = glXCreateContext(window.dpy, window.vi, NULL, GL_TRUE);
	glXMakeCurrent(window.dpy, window.win, window.glc); // bind it to the window

	glewInit();

	window.setSwapIntervalPointer = (PFNGLXSWAPINTERVALSGIPROC)glXGetProcAddress((const GLubyte *)"glXSwapIntervalSGI");
}

void agl::mapWindow(agl::BaseWindow &window)
{
	XMapWindow(window.dpy, window.win);
}

void agl::setSwapInterval(agl::BaseWindow &window, int i)
{
	window.setSwapIntervalPointer(i);
}

void agl::setCursorShape(agl::BaseWindow &window, unsigned int shape)
{
	Cursor c;
	c = XCreateFontCursor(window.dpy, shape);
	XDefineCursor(window.dpy, window.win, c);
}

void agl::swapBuffers(agl::BaseWindow &window)
{
	glXSwapBuffers(window.dpy, window.win);
}

void agl::closeWindow(agl::BaseWindow &window)
{
	glXMakeCurrent(window.dpy, None, NULL);	   // release gl binding to window
	glXDestroyContext(window.dpy, window.glc); // destroy context

	XFree(window.vi);						// delete the visual info data
	XDestroyWindow(window.dpy, window.win); // kill window
	XFreeColormap(window.dpy, window.cmap); // free colormap
	XCloseDisplay(window.dpy);				// close display
}

void agl::setupEvent(agl::BaseEvent &event, agl::BaseWindow &window)
{
	event.display = window.dpy;
	event.window  = window.win;

	event.wmDeleteMessage = XInternAtom(event.display, "WM_DELETE_WINDOW", False);
	XSetWMProtocols(event.display, event.window, &event.wmDeleteMessage, 1);

	event.xim = XOpenIM(window.dpy, nullptr, nullptr, nullptr);
	event.xic = XCreateIC(event.xim, XNInputStyle, XIMPreeditNothing | XIMStatusNothing, NULL);

	XSetICFocus(event.xic);

	XSelectInput(window.dpy, window.win, ButtonPressMask | KeyPressMask);
}

int agl::currentKeyPressed(agl::BaseEvent &event, char buffer[2])
{
	KeySym keysym;
	int	   bytes_buffer = 2;
	Status status;
	int	   len = Xutf8LookupString(event.xic, &event.xev.xkey, buffer, bytes_buffer, &keysym, &status);

	return len;
}

void agl::pollEvents(agl::BaseEvent &event, char keymap[32], agl::Vec<int, 2> &root, agl::Vec<int, 2> &win,
					 unsigned int &maskReturn, bool &shouldWindowClose, std::string &keybuffer, Direction &scroll)
{
	Window p;

	XQueryKeymap(event.display, keymap);
	XQueryPointer(event.display, event.window, &p, &p, &root.x, &root.y, &win.x, &win.y, &maskReturn);

	while (XPending(event.display))
	{
		XNextEvent(event.display, &event.xev);

		switch (event.xev.type)
		{
			case ClientMessage:
				shouldWindowClose = (event.xev.xclient.data.l[0] == event.wmDeleteMessage);
			case ButtonPress:
				if (event.xev.xbutton.button == 4)
				{
					scroll = Up;
				}
				else if (event.xev.xbutton.button == 5)
				{
					scroll = Down;
				}
			case KeyPress:
				char key[2];
				if (int size = agl::currentKeyPressed(event, key))
				{
					keybuffer += std::string().append(key, size);
				}
		}
	}

	event.xev = XEvent();
}

bool agl::isKeyPressed(agl::BaseEvent &event, char keymap[32], Key key)
{
	int keycode = XKeysymToKeycode(event.display, key.code);
	if (keymap[keycode / 8] & (0x1 << (keycode % 8)))
	{
		return true;
	}

	return false;
}

bool agl::isButtonPressed(agl::BaseEvent &event, int maskReturn, Button button)
{
	if (maskReturn & button.code)
	{
		return true;
	}

	return false;
}

agl::WindowState agl::getWindowState(agl::BaseWindow &window)
{
	XWindowAttributes att;
	XGetWindowAttributes(window.dpy, window.win, &att);

	return {{att.width, att.height}, {att.x, att.y}};
}

#endif
